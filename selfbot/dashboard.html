<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OwO Bot Dashboard</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;display:flex;min-height:100vh}
        
        /* Sidebar */
        .sidebar{width:250px;background:linear-gradient(180deg,#1a1a2e 0%,#16213e 100%);height:100vh;position:fixed;left:0;top:0;display:flex;flex-direction:column;box-shadow:2px 0 10px rgba(0,0,0,0.3)}
        .logo{padding:25px 20px;border-bottom:1px solid rgba(255,255,255,0.1)}
        .logo h2{color:#fff;text-align:center;font-size:22px}
        nav{flex:1;padding:20px 0}
        .nav-item{display:flex;align-items:center;gap:12px;padding:14px 25px;color:rgba(255,255,255,0.7);text-decoration:none;cursor:pointer;transition:all 0.3s;border-left:3px solid transparent}
        .nav-item:hover{background:rgba(255,255,255,0.05);color:#fff}
        .nav-item.active{background:rgba(102,126,234,0.2);color:#667eea;border-left-color:#667eea}
        .nav-item span:first-child{font-size:18px}
        .user-info{padding:20px;border-top:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;gap:12px}
        .user-info img{width:42px;height:42px;border-radius:50%;border:2px solid #667eea}
        .user-info .username{flex:1;color:#fff;font-size:14px;font-weight:500}
        .logout-btn{padding:8px 14px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;transition:background 0.3s}
        .logout-btn:hover{background:#c0392b}
        
        /* Main */
        .main-content{flex:1;margin-left:250px;padding:30px;min-height:100vh}
        .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px}
        .header h1{color:#1a1a2e;font-size:28px;font-weight:600}
        .bot-status{display:flex;align-items:center;gap:10px;padding:12px 20px;background:#fff;border-radius:50px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
        .status-dot{width:12px;height:12px;border-radius:50%;background:#e74c3c}
        .status-dot.online{background:#27ae60;animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(39,174,96,0.4)}50%{box-shadow:0 0 0 8px rgba(39,174,96,0)}}
        
        /* Pages */
        .page{display:none;animation:fadeIn 0.3s}
        .page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        
        /* Toolbar */
        .toolbar{display:flex;gap:12px;margin-bottom:25px;flex-wrap:wrap}
        
        /* Buttons */
        .btn{padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all 0.3s;display:inline-flex;align-items:center;justify-content:center;gap:8px;min-width:120px}
        .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15)}
        .btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
        .btn-primary{background:#667eea;color:#fff}
        .btn-primary:hover{background:#5a6fd6}
        .btn-success{background:#27ae60;color:#fff}
        .btn-success:hover{background:#219a52}
        .btn-danger{background:#e74c3c;color:#fff}
        .btn-danger:hover{background:#d63031}
        .btn-warning{background:#f39c12;color:#fff}
        .btn-warning:hover{background:#e67e22}
        .btn-secondary{background:#636e72;color:#fff}
        .btn-secondary:hover{background:#535c60}
        .btn-sm{padding:8px 14px;font-size:12px;min-width:auto}
        
        /* Account Cards */
        .accounts-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:20px}
        .account-card{background:#fff;border-radius:16px;padding:24px;box-shadow:0 4px 20px rgba(0,0,0,0.08);border:1px solid #eee;transition:all 0.3s;position:relative;overflow:hidden}
        .account-card:hover{transform:translateY(-5px);box-shadow:0 8px 30px rgba(0,0,0,0.12)}
        .account-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#667eea,#764ba2)}
        .account-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid #f0f0f0}
        .account-header h3{font-size:18px;color:#1a1a2e;font-weight:600}
        .status-badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;text-transform:uppercase}
        .status-badge.running{background:#d4edda;color:#155724}
        .status-badge.stopped{background:#f8d7da;color:#721c24}
        .status-badge.paused{background:#fff3cd;color:#856404}
        .status-badge.ready{background:#e2e3e5;color:#383d41}
        .account-info{margin-bottom:16px}
        .account-info .info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f5f5f5;font-size:14px}
        .account-info .info-row:last-child{border-bottom:none}
        .account-info .label{color:#666}
        .account-info .value{color:#1a1a2e;font-weight:500}
        .account-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;padding:12px;background:#f8f9fa;border-radius:10px}
        .account-stats .stat{text-align:center}
        .account-stats .stat-value{font-size:18px;font-weight:700;color:#667eea}
        .account-stats .stat-label{font-size:11px;color:#666;text-transform:uppercase}
        .account-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
        .account-actions .btn{width:100%}
        
        /* Stats Page */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px}
        .stat-card{background:#fff;padding:24px;border-radius:16px;text-align:center;box-shadow:0 4px 20px rgba(0,0,0,0.08);border:1px solid #eee;transition:transform 0.3s}
        .stat-card:hover{transform:translateY(-5px)}
        .stat-card .icon{font-size:32px;margin-bottom:10px}
        .stat-card h3{color:#666;font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
        .stat-card .value{font-size:32px;font-weight:700;background:linear-gradient(135deg,#667eea,#764ba2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
        .chart-container{background:#fff;padding:24px;border-radius:16px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
        
        /* Settings */
        .settings-section{background:#fff;padding:30px;border-radius:16px;margin-bottom:20px;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
        .settings-section h2{color:#1a1a2e;margin-bottom:24px;font-size:20px;padding-bottom:12px;border-bottom:2px solid #f0f0f0}
        .form-group{margin-bottom:20px}
        .form-group label{display:block;margin-bottom:8px;color:#333;font-weight:500;font-size:14px}
        .form-group input,.form-group select{width:100%;padding:12px 16px;border:2px solid #e0e0e0;border-radius:10px;font-size:14px;transition:all 0.3s;background:#fafafa}
        .form-group input:focus,.form-group select:focus{outline:none;border-color:#667eea;background:#fff;box-shadow:0 0 0 4px rgba(102,126,234,0.1)}
        .form-group small{display:block;margin-top:6px;color:#888;font-size:12px}
        .config-display pre{background:#1a1a2e;color:#27ae60;padding:20px;border-radius:10px;overflow-x:auto;font-family:'Fira Code',monospace;font-size:13px;line-height:1.6;max-height:400px}
        
        /* Logs */
        .logs-container{background:#fff;border-radius:16px;padding:24px;height:650px;display:flex;flex-direction:column;box-shadow:0 4px 20px rgba(0,0,0,0.08)}
        .logs-header{display:flex;gap:12px;margin-bottom:16px;padding-bottom:16px;border-bottom:1px solid #eee}
        .logs-content{flex:1;background:#1a1a2e;color:#27ae60;padding:16px;font-family:'Fira Code',Consolas,monospace;font-size:12px;overflow-y:auto;border-radius:10px;line-height:1.8}
        .log-entry{padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
        .log-entry.error{color:#e74c3c}
        .log-entry.warning{color:#f39c12}
        .log-entry.success{color:#27ae60}
        .log-entry.info{color:#3498db}
        
        /* Modal */
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center}
        .modal.show{display:flex}
        .modal-content{background:#fff;padding:32px;border-radius:20px;width:90%;max-width:480px;position:relative;animation:slideUp 0.3s}
        @keyframes slideUp{from{transform:translateY(30px);opacity:0}to{transform:translateY(0);opacity:1}}
        .modal-content h2{color:#1a1a2e;margin-bottom:24px;font-size:22px}
        .close{position:absolute;right:20px;top:20px;font-size:28px;cursor:pointer;color:#999;width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.3s}
        .close:hover{background:#f0f0f0;color:#e74c3c}
        
        /* Toast */
        .toast{position:fixed;bottom:24px;right:24px;padding:16px 24px;border-radius:12px;color:#fff;font-weight:500;opacity:0;transform:translateY(20px);transition:all 0.3s;z-index:2000;max-width:360px;box-shadow:0 8px 24px rgba(0,0,0,0.2)}
        .toast.show{opacity:1;transform:translateY(0)}
        .toast.success{background:#27ae60}
        .toast.error{background:#e74c3c}
        .toast.info{background:#3498db}
        .toast.warning{background:#f39c12}
        
        /* Empty State */
        .empty-state{text-align:center;padding:60px 20px;color:#888}
        .empty-state .icon{font-size:64px;margin-bottom:20px}
        .empty-state p{margin-bottom:20px;font-size:16px}
        
        /* Responsive */
        @media(max-width:768px){
            .sidebar{width:70px}
            .sidebar .logo h2,.nav-item span:last-child,.user-info .username{display:none}
            .main-content{margin-left:70px;padding:20px}
            .accounts-grid{grid-template-columns:1fr}
            .account-actions{grid-template-columns:1fr}
            .toolbar{flex-direction:column}
            .toolbar .btn{width:100%}
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo"><h2>ü¶â OwO Bot</h2></div>
        <nav>
            <a class="nav-item active" data-page="accounts"><span>üë§</span><span>Accounts</span></a>
            <a class="nav-item" data-page="stats"><span>üìä</span><span>Statistics</span></a>
            <a class="nav-item" data-page="settings"><span>‚öôÔ∏è</span><span>Settings</span></a>
            <a class="nav-item" data-page="logs"><span>üìú</span><span>Logs</span></a>
        </nav>
        <div class="user-info">
            <img id="userAvatar" src="https://cdn.discordapp.com/embed/avatars/0.png" alt="">
            <span class="username" id="username">Loading...</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h1 id="pageTitle">Accounts</h1>
            <div class="bot-status">
                <span class="status-dot" id="botStatus"></span>
                <span id="botStatusText">Bot Offline</span>
            </div>
        </div>
        
        <!-- Accounts Page -->
        <div id="accounts-page" class="page active">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showAddAccountModal()">‚ûï Add Account</button>
                <button class="btn btn-success" onclick="startAllAccounts()">‚ñ∂Ô∏è Start All</button>
                <button class="btn btn-danger" onclick="stopAllAccounts()">‚èπÔ∏è Stop All</button>
                <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
            </div>
            <div class="accounts-grid" id="accountsGrid">
                <div class="empty-state">
                    <div class="icon">‚è≥</div>
                    <p>Loading accounts...</p>
                </div>
            </div>
        </div>
        
        <!-- Stats Page -->
        <div id="stats-page" class="page">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">üéØ</div>
                    <h3>Total Hunts</h3>
                    <div class="value" id="statHunts">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ü¶â</div>
                    <h3>OwO Count</h3>
                    <div class="value" id="statOwo">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">‚öîÔ∏è</div>
                    <h3>Battles</h3>
                    <div class="value" id="statBattles">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üõ°Ô∏è</div>
                    <h3>Captchas</h3>
                    <div class="value" id="statCaptchas">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üë•</div>
                    <h3>Active Accounts</h3>
                    <div class="value" id="statActive">0</div>
                </div>
                <div class="stat-card">
                    <div class="icon">üìà</div>
                    <h3>Success Rate</h3>
                    <div class="value" id="statSuccess">100%</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="statsChart"></canvas>
            </div>
        </div>
        
        <!-- Settings Page -->
        <div id="settings-page" class="page">
            <div class="settings-section">
                <h2>‚öôÔ∏è Global Settings</h2>
                <form id="settingsForm">
                    <div class="form-group">
                        <label>Min Delay Between Accounts (ms)</label>
                        <input type="number" id="minDelay" min="1000" value="3000">
                        <small>Minimum delay between account actions</small>
                    </div>
                    <div class="form-group">
                        <label>Max Delay Between Accounts (ms)</label>
                        <input type="number" id="maxDelay" min="1000" value="5000">
                        <small>Maximum delay between account actions</small>
                    </div>
                    <div class="form-group">
                        <label>Default Action</label>
                        <select id="defaultAction">
                            <option value="pray">üôè Pray</option>
                            <option value="curse">üíÄ Curse</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">üíæ Save Settings</button>
                </form>
            </div>
            <div class="settings-section">
                <h2>üìÑ Bot Configuration</h2>
                <div class="config-display">
                    <pre id="configDisplay">{}</pre>
                </div>
                <br>
                <button class="btn btn-secondary" onclick="downloadConfig()">üì• Download config.js</button>
            </div>
        </div>
        
        <!-- Logs Page -->
        <div id="logs-page" class="page">
            <div class="logs-container">
                <div class="logs-header">
                    <button class="btn btn-secondary btn-sm" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                    <button class="btn btn-primary btn-sm" onclick="refreshLogs()">üîÑ Refresh</button>
                    <button class="btn btn-success btn-sm" onclick="exportLogs()">üì• Export</button>
                </div>
                <div class="logs-content" id="logsContent">
                    <div class="log-entry info">[System] Waiting for logs...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Account Modal -->
    <div id="addAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addAccountModal')">&times;</span>
            <h2>‚ûï Add New Account</h2>
            <form id="addAccountForm">
                <div class="form-group">
                    <label>Account Name</label>
                    <input type="text" id="accountName" required placeholder="Main Account">
                </div>
                <div class="form-group">
                    <label>Discord Token</label>
                    <input type="password" id="accountToken" required placeholder="Your Discord token">
                    <small>‚ö†Ô∏è Keep this secret!</small>
                </div>
                <div class="form-group">
                    <label>Channel ID</label>
                    <input type="text" id="channelId" placeholder="123456789012345678">
                    <small>Right-click channel ‚Üí Copy ID</small>
                </div>
                <div class="form-group">
                    <label>Prefix</label>
                    <input type="text" id="prefix" value="owo">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">‚ûï Add Account</button>
            </form>
        </div>
    </div>
    
    <!-- Edit Account Modal -->
    <div id="editAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('editAccountModal')">&times;</span>
            <h2>‚úèÔ∏è Edit Account</h2>
            <form id="editAccountForm">
                <input type="hidden" id="editAccountId">
                <div class="form-group">
                    <label>Account Name</label>
                    <input type="text" id="editAccountName" required>
                </div>
                <div class="form-group">
                    <label>Channel ID</label>
                    <input type="text" id="editChannelId">
                </div>
                <div class="form-group">
                    <label>Prefix</label>
                    <input type="text" id="editPrefix">
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">üíæ Save Changes</button>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    
    <script>
        // ============ CONFIGURATION ============
        const API_URL = 'https://oyy-gus.koyeb.app';
        const BASE_PATH = '/selfbot';
        // =======================================
        
        let socket = null;
        let userData = { accounts: [], globalSettings: {} };
        let chart = null;
        let logs = [];
        
        // ============ INIT ============
        async function init() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            if (!token) {
                window.location.href = BASE_PATH + '/';
                return;
            }
            
            // Set user info
            if (user.username) document.getElementById('username').textContent = user.username;
            if (user.avatar && user.discordId) {
                document.getElementById('userAvatar').src = `https://cdn.discordapp.com/avatars/${user.discordId}/${user.avatar}.png`;
            }
            
            setupNavigation();
            setupForms();
            await loadData();
            connectSocket();
            
            // Auto refresh every 30s
            setInterval(loadData, 30000);
        }
        
        // ============ SOCKET ============
        function connectSocket() {
            try {
                socket = io(API_URL, { transports: ['websocket', 'polling'], reconnection: true });
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                
                socket.on('connect', () => {
                    socket.emit('join-room', user.discordId);
                    updateBotStatus(true);
                    addLog('Connected to server', 'success');
                });
                
                socket.on('disconnect', () => {
                    updateBotStatus(false);
                    addLog('Disconnected from server', 'error');
                });
                
                socket.on('config-updated', (data) => {
                    userData = data;
                    renderAccounts();
                    updateStats();
                    addLog('Config updated from server', 'info');
                });
                
                socket.on('bot-status', (data) => {
                    updateBotStatus(data.online);
                    if (data.accounts) {
                        data.accounts.forEach(acc => {
                            const existing = userData.accounts?.find(a => a.name === acc.name);
                            if (existing) Object.assign(existing, acc);
                        });
                        renderAccounts();
                        updateStats();
                    }
                });
                
                socket.on('bot-log', (data) => {
                    addLog(data.message, data.type || 'info');
                });
                
            } catch (e) {
                console.error('Socket error:', e);
            }
        }
        
        function updateBotStatus(online) {
            const dot = document.getElementById('botStatus');
            const text = document.getElementById('botStatusText');
            if (online) {
                dot.classList.add('online');
                text.textContent = 'Bot Online';
            } else {
                dot.classList.remove('online');
                text.textContent = 'Bot Offline';
            }
        }
        
        // ============ DATA ============
        async function loadData() {
            const token = localStorage.getItem('token');
            try {
                const res = await fetch(`${API_URL}/api/config`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (!res.ok) {
                    if (res.status === 401) { logout(); return; }
                    throw new Error('Failed to load');
                }
                
                userData = await res.json();
                renderAccounts();
                updateStats();
                updateSettings();
                
            } catch (e) {
                showToast('Failed to load data', 'error');
            }
        }
        
        function refreshData() {
            loadData();
            showToast('Data refreshed', 'info');
        }
        
        // ============ RENDER ACCOUNTS ============
        function renderAccounts() {
            const grid = document.getElementById('accountsGrid');
            
            if (!userData.accounts || userData.accounts.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>No accounts added yet</p>
                        <button class="btn btn-primary" onclick="showAddAccountModal()">‚ûï Add Account</button>
                    </div>`;
                return;
            }
            
            grid.innerHTML = userData.accounts.map(acc => {
                const isRunning = acc.enabled && acc.statusHunting === 'aktif';
                const isPaused = acc.captchaDetected;
                
                let statusClass = 'stopped';
                let statusText = 'üî¥ Stopped';
                
                if (isPaused) {
                    statusClass = 'paused';
                    statusText = '‚è∏Ô∏è Paused';
                } else if (isRunning) {
                    statusClass = 'running';
                    statusText = 'üü¢ Running';
                } else if (acc.enabled) {
                    statusClass = 'ready';
                    statusText = 'üü° Ready';
                }
                
                return `
                <div class="account-card">
                    <div class="account-header">
                        <h3>${acc.name}</h3>
                        <span class="status-badge ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="account-info">
                        <div class="info-row">
                            <span class="label">Channel ID</span>
                            <span class="value">${acc.channelId || 'Not set'}</span>
                        </div>
                        <div class="info-row">
                            <span class="label">Prefix</span>
                            <span class="value">${acc.prefix || 'owo'}</span>
                        </div>
                    </div>
                    
                    <div class="account-stats">
                        <div class="stat">
                            <div class="stat-value">${acc.totalHunts || 0}</div>
                            <div class="stat-label">Hunts</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${acc.owoCount || 0}</div>
                            <div class="stat-label">OwO</div>
                        </div>
                        <div class="stat">
                            <div class="stat-value">${acc.battleCount || 0}</div>
                            <div class="stat-label">Battles</div>
                        </div>
                    </div>
                    
                    <div class="account-actions">
                        ${isRunning ? 
                            `<button class="btn btn-warning btn-sm" onclick="controlAccount('${acc._id}','stop')">‚èπÔ∏è Stop</button>` :
                            `<button class="btn btn-success btn-sm" onclick="controlAccount('${acc._id}','start')" ${!acc.channelId ? 'disabled' : ''}>‚ñ∂Ô∏è Start</button>`
                        }
                        <button class="btn btn-secondary btn-sm" onclick="toggleAccount('${acc._id}')">${acc.enabled ? 'üî¥ Disable' : 'üü¢ Enable'}</button>
                        <button class="btn btn-primary btn-sm" onclick="editAccount('${acc._id}')">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteAccount('${acc._id}')">üóëÔ∏è Delete</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        // ============ STATS ============
        function updateStats() {
            if (!userData.accounts) return;
            
            const totalHunts = userData.accounts.reduce((s, a) => s + (a.totalHunts || 0), 0);
            const totalOwo = userData.accounts.reduce((s, a) => s + (a.owoCount || 0), 0);
            const totalBattles = userData.accounts.reduce((s, a) => s + (a.battleCount || 0), 0);
            const totalCaptchas = userData.accounts.reduce((s, a) => s + (a.captchaCount || 0), 0);
            const activeCount = userData.accounts.filter(a => a.enabled && a.statusHunting === 'aktif').length;
            const successRate = totalHunts > 0 ? Math.round(((totalHunts - totalCaptchas) / totalHunts) * 100) : 100;
            
            document.getElementById('statHunts').textContent = totalHunts.toLocaleString();
            document.getElementById('statOwo').textContent = totalOwo.toLocaleString();
            document.getElementById('statBattles').textContent = totalBattles.toLocaleString();
            document.getElementById('statCaptchas').textContent = totalCaptchas.toLocaleString();
            document.getElementById('statActive').textContent = activeCount;
            document.getElementById('statSuccess').textContent = successRate + '%';
        }
        
        function updateChart() {
            const ctx = document.getElementById('statsChart');
            if (!ctx || !userData.accounts) return;
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: userData.accounts.map(a => a.name),
                    datasets: [
                        { label: 'Hunts', data: userData.accounts.map(a => a.totalHunts || 0), backgroundColor: '#667eea' },
                        { label: 'OwO', data: userData.accounts.map(a => a.owoCount || 0), backgroundColor: '#27ae60' },
                        { label: 'Battles', data: userData.accounts.map(a => a.battleCount || 0), backgroundColor: '#e74c3c' }
                    ]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function updateSettings() {
            if (userData.globalSettings) {
                document.getElementById('minDelay').value = userData.globalSettings.minDelayBetweenAccounts || 3000;
                document.getElementById('maxDelay').value = userData.globalSettings.maxDelayBetweenAccounts || 5000;
                document.getElementById('defaultAction').value = userData.globalSettings.action || 'pray';
            }
            document.getElementById('configDisplay').textContent = JSON.stringify(generateConfig(), null, 2);
        }
        
        // ============ ACCOUNT ACTIONS ============
        async function controlAccount(id, action) {
            const token = localStorage.getItem('token');
            const acc = userData.accounts.find(a => a._id === id);
            
            try {
                showToast(`${action === 'start' ? 'Starting' : 'Stopping'} ${acc.name}...`, 'info');
                
                await fetch(`${API_URL}/api/bot/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ command: action, target: 'account', accountId: id, accountName: acc.name })
                });
                
                showToast(`${acc.name} ${action}ed!`, 'success');
                addLog(`${acc.name} ${action}ed`, 'success');
                setTimeout(loadData, 1500);
            } catch (e) {
                showToast('Error: ' + e.message, 'error');
            }
        }
        
        async function startAllAccounts() {
            const token = localStorage.getItem('token');
            try {
                showToast('Starting all accounts...', 'info');
                await fetch(`${API_URL}/api/bot/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ command: 'startAll', target: 'all' })
                });
                showToast('All accounts starting!', 'success');
                addLog('Started all accounts', 'success');
                setTimeout(loadData, 2000);
            } catch (e) { showToast('Error', 'error'); }
        }
        
        async function stopAllAccounts() {
            const token = localStorage.getItem('token');
            try {
                showToast('Stopping all accounts...', 'info');
                await fetch(`${API_URL}/api/bot/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ command: 'stopAll', target: 'all' })
                });
                showToast('All accounts stopped!', 'success');
                addLog('Stopped all accounts', 'warning');
                setTimeout(loadData, 2000);
            } catch (e) { showToast('Error', 'error'); }
        }
        
        async function toggleAccount(id) {
            const token = localStorage.getItem('token');
            const acc = userData.accounts.find(a => a._id === id);
            
            try {
                await fetch(`${API_URL}/api/config/account/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ enabled: !acc.enabled })
                });
                showToast(`Account ${acc.enabled ? 'disabled' : 'enabled'}`, 'success');
                loadData();
            } catch (e) { showToast('Error', 'error'); }
        }
        
        async function deleteAccount(id) {
            if (!confirm('Delete this account?')) return;
            const token = localStorage.getItem('token');
            
            try {
                await fetch(`${API_URL}/api/config/account/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                showToast('Account deleted', 'success');
                addLog('Account deleted', 'warning');
                loadData();
            } catch (e) { showToast('Error', 'error'); }
        }
        
        function editAccount(id) {
            const acc = userData.accounts.find(a => a._id === id);
            if (!acc) return;
            
            document.getElementById('editAccountId').value = acc._id;
            document.getElementById('editAccountName').value = acc.name;
            document.getElementById('editChannelId').value = acc.channelId || '';
            document.getElementById('editPrefix').value = acc.prefix || 'owo';
            
            document.getElementById('editAccountModal').classList.add('show');
        }
        
        // ============ LOGS ============
        function addLog(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            logs.unshift({ time, message, type });
            if (logs.length > 500) logs.pop();
            renderLogs();
        }
        
        function renderLogs() {
            const container = document.getElementById('logsContent');
            if (logs.length === 0) {
                container.innerHTML = '<div class="log-entry info">[System] No logs yet</div>';
                return;
            }
            
            container.innerHTML = logs.map(log => 
                `<div class="log-entry ${log.type}">[${log.time}] ${log.message}</div>`
            ).join('');
        }
        
        function clearLogs() {
            logs = [];
            addLog('Logs cleared', 'info');
        }
        
        function refreshLogs() {
            addLog('Logs refreshed', 'info');
        }
        
        function exportLogs() {
            const content = logs.map(l => `[${l.time}] [${l.type.toUpperCase()}] ${l.message}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `owo-bot-logs-${Date.now()}.txt`;
            a.click();
            showToast('Logs exported', 'success');
        }
        
        // ============ NAVIGATION ============
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    const page = document.getElementById(`${item.dataset.page}-page`);
                    if (page) page.classList.add('active');
                    
                    const titles = { accounts: 'Accounts', stats: 'Statistics', settings: 'Settings', logs: 'Logs' };
                    document.getElementById('pageTitle').textContent = titles[item.dataset.page] || 'Dashboard';
                    
                    if (item.dataset.page === 'stats') updateChart();
                });
            });
        }
        
        // ============ FORMS ============
        function setupForms() {
            document.getElementById('addAccountForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('token');
                
                try {
                    const res = await fetch(`${API_URL}/api/config/account`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            name: document.getElementById('accountName').value,
                            token: document.getElementById('accountToken').value,
                            channelId: document.getElementById('channelId').value,
                            prefix: document.getElementById('prefix').value || 'owo'
                        })
                    });
                    
                    if (!res.ok) throw new Error((await res.json()).error);
                    
                    showToast('Account added!', 'success');
                    addLog('New account added', 'success');
                    closeModal('addAccountModal');
                    document.getElementById('addAccountForm').reset();
                    loadData();
                } catch (e) {
                    showToast('Error: ' + e.message, 'error');
                }
            });
            
            document.getElementById('editAccountForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('token');
                const id = document.getElementById('editAccountId').value;
                
                try {
                    await fetch(`${API_URL}/api/config/account/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            name: document.getElementById('editAccountName').value,
                            channelId: document.getElementById('editChannelId').value,
                            prefix: document.getElementById('editPrefix').value
                        })
                    });
                    
                    showToast('Account updated!', 'success');
                    closeModal('editAccountModal');
                    loadData();
                } catch (e) { showToast('Error', 'error'); }
            });
            
            document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const token = localStorage.getItem('token');
                
                try {
                    await fetch(`${API_URL}/api/config/global`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({
                            minDelayBetweenAccounts: parseInt(document.getElementById('minDelay').value),
                            maxDelayBetweenAccounts: parseInt(document.getElementById('maxDelay').value),
                            action: document.getElementById('defaultAction').value
                        })
                    });
                    
                    showToast('Settings saved!', 'success');
                    addLog('Settings updated', 'info');
                } catch (e) { showToast('Error', 'error'); }
            });
        }
        
        // ============ UTILS ============
        function generateConfig() {
            return {
                owoId: "408785106942164992",
                accounts: (userData.accounts || []).map(a => ({
                    name: a.name, token: 'HIDDEN', channelId: a.channelId,
                    channelIds: a.channelIds || [], prefix: a.prefix,
                    statusHunting: a.statusHunting, enabled: a.enabled
                })),
                globalSettings: userData.globalSettings || {}
            };
        }
        
        function downloadConfig() {
            const blob = new Blob([`module.exports = ${JSON.stringify(generateConfig(), null, 4)};`], { type: 'text/javascript' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'config.js';
            a.click();
            showToast('Config downloaded!', 'success');
        }
        
        function showAddAccountModal() { document.getElementById('addAccountModal').classList.add('show'); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function showToast(msg, type = 'info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast show ${type}`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        function logout() {
            localStorage.clear();
            window.location.href = BASE_PATH + '/';
        }
        
        // Close modal on outside click
        window.onclick = (e) => {
            if (e.target.classList.contains('modal')) e.target.classList.remove('show');
        };
        
        // Init
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>